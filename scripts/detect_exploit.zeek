module CVE20223602;

export {
	redef enum Notice::Type += { CVE_2022_3602_Exploit_Attempt };
}

global email = /email:/;
global puny = /xn--/;

event x509_extension(f: fa_file, ext: X509::Extension)
	{
	if ( ext?$short_name && ext$short_name != "nameConstraints" )
		return;
	if ( email in ext$value && puny in ext$value )
		{
		for ( cid in f$conns )
			{
			local c: connection = f$conns[cid];
			NOTICE([$note=CVE_2022_3602_Exploit_Attempt, $conn=c, $identifier=cat(
			    c$id$orig_h, c$id$resp_h, ext$value), $msg="Potential OpenSSL CVE_2022_3602 exploit attempt (punycode)",
			    $sub=fmt("ext$value = '%s'", ext$value)]);
			}
		}
	}
